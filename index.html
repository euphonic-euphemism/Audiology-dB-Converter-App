<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dB HL to SPL Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!--
      ELECTRON FIX:
      1. We use the explicit UMD build of Chart.js to ensure it registers as a global variable.
      2. We temporarily hide 'module' to prevent it from registering as a CommonJS module in Electron.
    -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>if (window.module) module = window.module;</script>

    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Custom styles for professional look and feel */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0px 10px -5px rgba(0, 0, 0, 0.04);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Result box transitions */
        .result-box {
            transition: all 0.3s ease;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Range slider styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #4b5563;
        }
        input[type=range]:focus {
            outline: none;
        }
        /* Custom scrollbar for dark mode aesthetics */
        .dark ::-webkit-scrollbar {
            width: 8px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen bg-[#f7f9fb] dark:bg-gray-900 text-gray-800 dark:text-gray-100">

    <div id="app" class="w-full max-w-4xl card bg-white dark:bg-gray-800 rounded-xl p-6 md:p-10 relative">

        <!-- Action Buttons Container -->
        <div class="absolute top-6 right-6 flex space-x-2">
            <!-- Chart Toggle Button -->
            <button onclick="toggleChartModal()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-600 dark:text-gray-300" aria-label="View RETSPL Chart" title="View RETSPL Chart">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
            </button>

            <!-- Dark Mode Toggle Button -->
            <button onclick="toggleTheme()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Toggle Dark Mode" title="Toggle Dark Mode">
                <!-- Sun Icon (for Dark Mode) -->
                <svg id="sunIcon" class="w-5 h-5 text-yellow-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Moon Icon (for Light Mode) -->
                <svg id="moonIcon" class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>

        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Audiometric Converter</h1>
        <p class="text-sm text-indigo-600 dark:text-indigo-400 mb-6 border-b dark:border-gray-700 pb-4">Clinical & Acoustic Utilities</p>

        <!-- View Switcher -->
        <div class="flex justify-center mb-8">
            <div class="bg-gray-100 dark:bg-gray-700 p-1 rounded-lg inline-flex">
                <button id="btnSingle" onclick="switchView('single')" class="px-4 py-2 rounded-md text-sm font-medium bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm transition-all focus:outline-none">Single Frequency</button>
                <button id="btnBulk" onclick="switchView('bulk')" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all focus:outline-none">Full Audiogram</button>
                <button id="btnAcoustics" onclick="switchView('acoustics')" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all focus:outline-none">Acoustics Tools</button>
            </div>
        </div>

        <!-- ==================== HL -> SPL CONVERTER VIEWS ==================== -->
        <div id="converterContainer">
            <!-- Conversion Direction Toggle -->
            <div class="mb-6 flex justify-center">
                <div class="flex space-x-6">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="conversionDirection" value="HL_to_SPL" checked class="form-radio text-indigo-600 dark:text-indigo-500 h-4 w-4 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-indigo-500" onchange="updateUIAndCalculate()">
                        <span class="ml-2 text-gray-700 dark:text-gray-300 font-medium">dB HL &rarr; dB SPL</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="conversionDirection" value="SPL_to_HL" class="form-radio text-indigo-600 dark:text-indigo-500 h-4 w-4 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-indigo-500" onchange="updateUIAndCalculate()">
                        <span class="ml-2 text-gray-700 dark:text-gray-300 font-medium">dB SPL &rarr; dB HL</span>
                    </label>
                </div>
            </div>

            <!-- Global Settings (Applies to both views) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Transducer Selection -->
                <div>
                    <label for="transducer" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Transducer Type</label>
                    <select id="transducer" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border-2 shadow-sm transition-colors" onchange="handleTransducerChange()">
                        <option value="TDH">Supra-aural Headphone (TDH-49)</option>
                        <option value="TDH39">Supra-aural Headphone (TDH-39)</option>
                        <option value="ER3A">Insert Earphone (ER-3A)</option>
                        <option value="CAH">Circumaural Headphone (HDA-200)</option>
                        <option value="SF">Soundfield (Binaural, 0° Azimuth)</option>
                    </select>
                </div>

                <!-- RECD / REDD / REUG Section -->
                <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-100 dark:border-indigo-800 relative">
                    <label id="correctionSectionLabel" class="block text-sm font-medium text-indigo-700 dark:text-indigo-300 mb-2">Real-Ear Corrections</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label id="recdSourceLabel" for="recdSource" class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Source</label>
                            <select id="recdSource" class="block w-full pl-2 pr-8 py-2 text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm" onchange="handleRECDChange()">
                                <option value="NONE">None</option>
                                <option value="ADULT" id="adultRecdOption">Average Adult</option>
                                <option value="CUSTOM">Custom Value</option>
                            </select>
                        </div>
                        <div>
                            <label id="recdValueLabel" for="recdValue" class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Value (dB)</label>
                            <input type="number" id="recdValue" oninput="performConversion()" disabled class="block w-full pl-3 pr-3 py-2 text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-50 disabled:bg-gray-100 dark:disabled:bg-gray-800" placeholder="0">
                            <p id="bulkRecdWarning" class="hidden text-[10px] text-orange-500 mt-1 leading-tight">Using freq-specific averages in list view.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 1: SINGLE FREQUENCY -->
            <div id="singleView" class="block">
                <div class="space-y-6 mb-8">
                    <!-- Frequency Selection -->
                    <div>
                        <label for="frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Stimulus / Frequency</label>
                        <select id="frequency" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border-2 shadow-sm transition-colors" onchange="performConversion()">
                            <!-- Common audiometric frequencies -->
                            <option value="125">125 Hz</option>
                            <option value="250">250 Hz</option>
                            <option value="500">500 Hz</option>
                            <option value="750">750 Hz</option>
                            <option value="1000" selected>1000 Hz</option>
                            <option value="1500">1500 Hz</option>
                            <option value="2000">2000 Hz</option>
                            <option value="3000">3000 Hz</option>
                            <option value="4000">4000 Hz</option>
                            <option value="6000">6000 Hz</option>
                            <option value="8000">8000 Hz</option>
                            <!-- Extended High Frequencies (Initially hidden, only for CAH) -->
                            <option value="9000">9000 Hz</option>
                            <option value="10000">10000 Hz</option>
                            <option value="11200">11200 Hz</option>
                            <option value="12500">12500 Hz</option>
                            <option value="14000">14000 Hz</option>
                            <option value="16000">16000 Hz</option>
                            <option value="SPEECH">Speech (Broadband)</option>
                        </select>
                    </div>

                    <!-- dB Input -->
                    <div>
                        <label for="dbInput" id="inputLabel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Input Value: dB HL</label>
                        <div class="mt-1 relative rounded-lg shadow-sm">
                            <input type="number" id="dbInput" oninput="performConversion()" class="block w-full px-12 py-3 text-center border-red-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-lg rounded-lg border-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors" placeholder="e.g., 50" min="-10" max="120" value="50">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span id="inputUnit" class="text-gray-500 dark:text-gray-400 sm:text-sm">dB HL</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Output Result -->
                <div id="resultOutput" class="result-box p-6 rounded-xl transition-all duration-300 ease-in-out bg-[#e0f2f1] border-[#009688] dark:bg-teal-900/30 dark:border-teal-500">
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-center" id="outputLabel">Calculated dB SPL</p>
                    <div class="flex items-baseline justify-center gap-2">
                        <p id="outputValue" class="text-5xl font-extrabold text-teal-700 dark:text-teal-400 leading-none">57.5</p>
                        <span id="outputUnit" class="text-xl text-teal-600 dark:text-teal-500 font-semibold">dB SPL</span>
                    </div>
                    <p id="outputNote" class="text-xs text-center mt-2 text-teal-800 dark:text-teal-300 opacity-80 font-medium hidden"></p>
                </div>

                <!-- Reference Value Display -->
                <div class="mt-6 text-xs text-gray-500 dark:text-gray-400 p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg space-y-2">
                    <p id="retsplDisplay">Reference Equivalent Sound Pressure Level (RETSPL) used: <span class="font-bold text-gray-700 dark:text-gray-300">7.5 dB SPL</span> (based on TDH-49 @ 1000 Hz).</p>
                    <p id="reddDisplay" class="hidden border-t dark:border-gray-600 pt-2 text-indigo-600 dark:text-indigo-400 font-medium">
                        Calculated REDD (Real-Ear-to-Dial Difference): 0.0 dB
                    </p>
                    <p class="mt-1" id="formulaDisplay">Formula: dB SPL = dB HL + RETSPL</p>
                </div>
            </div>

            <!-- VIEW 2: FULL AUDIOGRAM (BULK) -->
            <div id="bulkView" class="hidden">
                <div class="overflow-x-auto">
                    <div id="bulkGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <!-- Bulk inputs generated by JS -->
                    </div>
                </div>

                <!-- PTA Summary Box -->
                <div class="mt-6 p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg border border-indigo-100 dark:border-indigo-800">
                    <h3 class="text-sm font-bold text-indigo-800 dark:text-indigo-300 mb-3">Pure-Tone Averages (Calculated)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Standard PTA -->
                        <div class="bg-white dark:bg-gray-800 p-3 rounded shadow-sm">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Standard PTA (500, 1k, 2k Hz)</p>
                            <div class="flex justify-between items-end">
                                <div>
                                    <span id="ptaHl" class="text-lg font-bold text-gray-800 dark:text-white">-</span>
                                    <span class="text-xs text-gray-500">dB HL</span>
                                </div>
                                <div class="text-right">
                                    <span id="ptaSpl" class="text-lg font-bold text-teal-600 dark:text-teal-400">-</span>
                                    <span class="text-xs text-gray-500">dB SPL</span>
                                </div>
                            </div>
                        </div>

                        <!-- High Frequency PTA -->
                        <div class="bg-white dark:bg-gray-800 p-3 rounded shadow-sm">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">High-Freq PTA (3k, 4k, 6k Hz)</p>
                            <div class="flex justify-between items-end">
                                <div>
                                    <span id="hfPtaHl" class="text-lg font-bold text-gray-800 dark:text-white">-</span>
                                    <span class="text-xs text-gray-500">dB HL</span>
                                </div>
                                <div class="text-right">
                                    <span id="hfPtaSpl" class="text-lg font-bold text-teal-600 dark:text-teal-400">-</span>
                                    <span class="text-xs text-gray-500">dB SPL</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Adult, Desensitized SII -->
                    <div class="mt-4 bg-white dark:bg-gray-800 p-3 rounded shadow-sm border-t-2 border-indigo-100 dark:border-indigo-800">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Adult, Desensitized SII (Calculated)</p>
                        <div class="flex justify-between items-end">
                            <div>
                                <span id="siiValue" class="text-lg font-bold text-indigo-700 dark:text-indigo-400">-</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-gray-400 italic">Formula: -0.012(PTA) - 0.006(HFPTA) + 1.311</span>
                            </div>
                        </div>
                    </div>

                    <!-- Adult, NAL-NL2, Desensitized SII -->
                    <div class="mt-4 bg-white dark:bg-gray-800 p-3 rounded shadow-sm border-t-2 border-indigo-100 dark:border-indigo-800">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Adult, NAL-NL2, Desensitized SII (Calculated)</p>
                        <div class="flex justify-between items-end">
                            <div>
                                <span id="nalSiiValue" class="text-lg font-bold text-indigo-700 dark:text-indigo-400">-</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-gray-400 italic">Formula: -0.008(PTA) - 0.005(HFPTA) + 1.294</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-center">
                    <button onclick="toggleSiiChartModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-sm font-medium transition-colors">
                        View SII Sensitivity Chart
                    </button>
                </div>

                <div class="mt-6 text-center text-xs text-gray-500 dark:text-gray-400">
                    <p>Calculations applied instantly based on Transducer and Correction settings above.</p>
                </div>
            </div>
        </div>

        <!-- ==================== ACOUSTICS TOOLS VIEW ==================== -->
        <div id="acousticsView" class="hidden space-y-6">

            <!-- Tool 1: dB Summation -->
            <div class="bg-white dark:bg-gray-700 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-600 relative">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white">dB Logarithmic Addition</h3>
                    <button onclick="toggleMath('mathSum')" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline focus:outline-none">Show Math</button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Calculate the combined level of two sound sources.</p>

                <!-- Math Display -->
                <div id="mathSum" class="hidden mb-4 p-3 bg-indigo-50 dark:bg-gray-800 rounded border border-indigo-100 dark:border-gray-600 text-xs text-gray-700 dark:text-gray-300 font-mono">
                    <p class="font-bold mb-1">Uncorrelated (Incoherent):</p>
                    <p class="mb-2">L_total = 10 · log₁₀( 10^(L₁/10) + 10^(L₂/10) )</p>
                    <p class="font-bold mb-1">Correlated (Coherent):</p>
                    <p>L_total = 10 · log₁₀( p₁² + p₂² + 2·p₁·p₂·cos(θ) )</p>
                    <p class="text-[10px] text-gray-500 mt-1 italic">where p = 10^(L/20) and θ is phase in degrees.</p>
                </div>

                <div class="flex items-center mb-4">
                    <input type="checkbox" id="correlatedSources" onchange="togglePhaseInput()" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded dark:bg-gray-800 dark:border-gray-500">
                    <label for="correlatedSources" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Coherent Sources (Correlated Phase)
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Level 1 (dB SPL)</label>
                        <input type="number" id="sumDb1" oninput="calculateDbSum()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Level 2 (dB SPL)</label>
                        <input type="number" id="sumDb2" oninput="calculateDbSum()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                </div>

                <!-- Phase Input (Hidden by default) -->
                <div id="phaseInputContainer" class="grid grid-cols-2 gap-4 mb-4 hidden">
                    <!-- Column 1: Aligns perfectly with Level 1 -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Phase Difference (Degrees)</label>
                        <input type="number" id="phaseNum" min="0" max="360" value="0" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500 mb-2" oninput="document.getElementById('phaseRange').value = this.value; calculateDbSum()">
                        <input type="range" id="phaseRange" min="0" max="180" value="0" class="w-full" oninput="document.getElementById('phaseNum').value = this.value; calculateDbSum()">
                        <p class="text-[10px] text-gray-500 mt-1">0° = Constructive (+6dB), 180° = Destructive (Cancel)</p>
                    </div>
                    <!-- Empty Column 2 -->
                    <div></div>
                </div>

                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Sum:</span>
                    <span id="sumResult" class="text-xl font-bold text-indigo-600 dark:text-indigo-400">- dB SPL</span>
                </div>
            </div>

            <!-- Tool 1.5: dB Subtraction -->
            <div class="bg-white dark:bg-gray-700 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-600 relative">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white">dB Logarithmic Subtraction</h3>
                    <button onclick="toggleMath('mathSub')" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline focus:outline-none">Show Math</button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Calculate the difference between two levels (e.g., remove background noise).</p>

                <!-- Math Display -->
                <div id="mathSub" class="hidden mb-4 p-3 bg-indigo-50 dark:bg-gray-800 rounded border border-indigo-100 dark:border-gray-600 text-xs text-gray-700 dark:text-gray-300 font-mono">
                    <p class="font-bold mb-1">Uncorrelated (Energy Subtraction):</p>
                    <p class="mb-2">L_result = 10 · log₁₀( 10^(L_total/10) - 10^(L_sub/10) )</p>
                    <p class="font-bold mb-1">Correlated (Vector Difference):</p>
                    <p>L_result = 10 · log₁₀( p_1² + p_2² - 2·p_1·p_2·cos(θ) )</p>
                    <p class="text-[10px] text-gray-500 mt-1 italic">where p = 10^(L/20) and θ is phase in degrees.</p>
                </div>

                <div class="flex items-center mb-4">
                    <input type="checkbox" id="correlatedSourcesSub" onchange="togglePhaseInputSub()" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded dark:bg-gray-800 dark:border-gray-500">
                    <label for="correlatedSourcesSub" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Coherent Sources (Correlated Phase)
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Total Level / Level 1</label>
                        <input type="number" id="subDb1" oninput="calculateDbSub()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Level 2 (to subtract)</label>
                        <input type="number" id="subDb2" oninput="calculateDbSub()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                </div>

                <!-- Phase Input Subtraction (Hidden by default) -->
                <div id="phaseInputContainerSub" class="grid grid-cols-2 gap-4 mb-4 hidden">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Phase Difference (Degrees)</label>
                        <input type="number" id="phaseNumSub" min="0" max="360" value="0" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500 mb-2" oninput="document.getElementById('phaseRangeSub').value = this.value; calculateDbSub()">
                        <input type="range" id="phaseRangeSub" min="0" max="180" value="0" class="w-full" oninput="document.getElementById('phaseNumSub').value = this.value; calculateDbSub()">
                    </div>
                    <div></div>
                </div>

                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Result:</span>
                    <span id="subResult" class="text-xl font-bold text-indigo-600 dark:text-indigo-400">- dB SPL</span>
                </div>
            </div>

            <!-- Tool 2: Inverse Square Law -->
            <div class="bg-white dark:bg-gray-700 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-600">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white">Inverse Square Law</h3>
                    <button onclick="toggleMath('mathIsl')" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline focus:outline-none">Show Math</button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Calculate attenuation over distance in a free field.</p>

                <!-- Math Display -->
                <div id="mathIsl" class="hidden mb-4 p-3 bg-indigo-50 dark:bg-gray-800 rounded border border-indigo-100 dark:border-gray-600 text-xs text-gray-700 dark:text-gray-300 font-mono">
                    <p>L₂ = L₁ - 20 · log₁₀( d₂ / d₁ )</p>
                    <p class="text-[10px] text-gray-500 mt-1 italic">Note: Doubling distance results in -6 dB change.</p>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Source Level (dB SPL)</label>
                        <input type="number" id="islLevel" oninput="calculateISL()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Distance 1 (m, ft, etc.)</label>
                        <input type="number" id="islD1" oninput="calculateISL()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Distance 2 (same unit)</label>
                        <input type="number" id="islD2" oninput="calculateISL()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                </div>
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Level at Dist 2:</span>
                    <span id="islResult" class="text-xl font-bold text-indigo-600 dark:text-indigo-400">- dB SPL</span>
                </div>
            </div>

            <!-- Tool 3: Noise Exposure Calculator -->
            <div class="bg-white dark:bg-gray-700 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-600">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-3">Noise Exposure (Dose & TWA)</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Calculate daily dose and 8-hour TWA for a specific exposure level.</p>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Noise Level (dBA)</label>
                        <input type="number" id="expLevel" oninput="calculateExposure()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Duration (Hours)</label>
                        <input type="number" id="expDuration" oninput="calculateExposure()" class="block w-full p-2 text-sm border-2 border-gray-400 dark:border-gray-500 dark:bg-gray-800 dark:text-white rounded focus:ring-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- OSHA Results -->
                    <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-2">OSHA (5dB exch)</p>
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-gray-600 dark:text-gray-400">Dose:</span>
                            <span id="oshaDose" class="font-bold text-indigo-600 dark:text-indigo-400">- %</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600 dark:text-gray-400">TWA:</span>
                            <span id="oshaTwa" class="font-bold text-indigo-600 dark:text-indigo-400">- dBA</span>
                        </div>
                    </div>
                    <!-- NIOSH Results -->
                    <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-2">NIOSH (3dB exch)</p>
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-gray-600 dark:text-gray-400">Dose:</span>
                            <span id="nioshDose" class="font-bold text-teal-600 dark:text-teal-400">- %</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs text-gray-600 dark:text-gray-400">TWA:</span>
                            <span id="nioshTwa" class="font-bold text-teal-600 dark:text-teal-400">- dBA</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Chart Modal (Same as before) -->
    <div id="chartModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" aria-hidden="true" onclick="toggleChartModal()"></div>

            <!-- Modal panel -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white dark:bg-gray-800 rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white" id="modal-title">Transducer RETSPL Curves</h3>
                    <button onclick="toggleChartModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="mt-2 bg-white dark:bg-gray-700 rounded-lg p-2">
                    <canvas id="retsplChart"></canvas>
                </div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm" onclick="toggleChartModal()">
                        Close
                    </button>
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600" onclick="exportChart()">
                        Export PNG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SII Chart Modal -->
    <div id="siiChartModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" aria-hidden="true" onclick="toggleSiiChartModal()"></div>

            <!-- Modal panel -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white dark:bg-gray-800 rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white" id="modal-title">Desensitized SII Sensitivity</h3>
                    <button onclick="toggleSiiChartModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="mt-2 bg-white dark:bg-gray-700 rounded-lg p-2">
                    <canvas id="siiChartCanvas"></canvas>
                </div>
                <div class="mt-5 sm:mt-6">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm" onclick="toggleSiiChartModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Dark Mode Logic ---
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            sunIcon.classList.add('hidden');
            moonIcon.classList.remove('hidden');
        }

        // --- Data ---
        const RETSPL_REFERENCES = {
            'TDH': { 125: 47.5, 250: 26.5, 500: 13.5, 750: 8.5, 1000: 7.5, 1500: 7.5, 2000: 11.0, 3000: 9.5, 4000: 10.5, 6000: 13.5, 8000: 13.0, 'SPEECH': 20.0 },
            'TDH39': { 125: 45.0, 250: 25.5, 500: 11.5, 750: 8.0, 1000: 7.0, 1500: 6.5, 2000: 9.0, 3000: 10.0, 4000: 9.5, 6000: 15.5, 8000: 13.0, 'SPEECH': 19.5 },
            'ER3A': { 125: 26.0, 250: 14.0, 500: 5.5, 750: 2.0, 1000: 0.0, 1500: 2.0, 2000: 3.0, 3000: 3.5, 4000: 5.5, 6000: 2.0, 8000: 0.0, 'SPEECH': 12.5 },
            'CAH': { 125: 30.5, 250: 18.0, 500: 11.0, 750: 8.5, 1000: 5.5, 1500: 5.5, 2000: 4.5, 3000: 2.5, 4000: 9.5, 6000: 17.0, 8000: 17.5, 9000: 19.0, 10000: 22.0, 11200: 23.0, 12500: 24.5, 14000: 31.5, 16000: 33.5, 'SPEECH': 19.0 },
            'SF': { 125: 22.0, 250: 11.0, 500: 4.0, 750: 2.0, 1000: 2.0, 1500: 0.5, 2000: -1.5, 3000: -6.0, 4000: -6.5, 6000: 2.5, 8000: 11.5, 'SPEECH': 14.5 }
        };

        const CORRECTION_DATA = {
            'INSERT': { 125: 0, 250: 2, 500: 4, 750: 5, 1000: 7, 1500: 9, 2000: 12, 3000: 13, 4000: 14, 6000: 12, 8000: 10, 'SPEECH': 7 },
            'TDH': { 125: 0, 250: 3, 500: 4, 750: 3, 1000: 3, 1500: 5, 2000: 8, 3000: 8, 4000: 2, 6000: -5, 8000: -10, 'SPEECH': 3 },
            'SF': { 125: 0, 250: 1, 500: 2.5, 750: 3, 1000: 2.6, 1500: 8, 2000: 12, 3000: 15.5, 4000: 13.5, 6000: 7, 8000: 2, 'SPEECH': 5 },
            'DEFAULT': { 125: 0, 250: 0, 500: 0, 750: 0, 1000: 0, 1500: 0, 2000: 0, 3000: 0, 4000: 0, 6000: 0, 8000: 0, 'SPEECH': 0 }
        };

        const TRANSDUCER_NAMES = {
            'TDH': 'TDH-49 Supra-aural (NBS-9A)',
            'TDH39': 'TDH-39 Supra-aural (NBS-9A)',
            'ER3A': 'ER-3A Insert (HA-2)',
            'CAH': 'HDA-200 Circumaural',
            'SF': 'Soundfield (Binaural 0°)'
        };

        // UI References
        const resultOutput = document.getElementById('resultOutput');
        const outputValueElement = document.getElementById('outputValue');
        const retsplDisplay = document.getElementById('retsplDisplay');
        const reddDisplay = document.getElementById('reddDisplay');
        const formulaDisplay = document.getElementById('formulaDisplay');
        const dbInput = document.getElementById('dbInput');
        const frequencySelect = document.getElementById('frequency');
        const transducerSelect = document.getElementById('transducer');
        const recdSourceSelect = document.getElementById('recdSource');
        const recdValueInput = document.getElementById('recdValue');
        const adultRecdOption = document.getElementById('adultRecdOption');
        const correctionSectionLabel = document.getElementById('correctionSectionLabel');
        const recdSourceLabel = document.getElementById('recdSourceLabel');
        const recdValueLabel = document.getElementById('recdValueLabel');
        const inputLabel = document.getElementById('inputLabel');
        const outputLabel = document.getElementById('outputLabel');
        const inputUnit = document.getElementById('inputUnit');
        const outputUnit = document.getElementById('outputUnit');
        const outputNote = document.getElementById('outputNote'); // New Note Element

        // Views
        const singleView = document.getElementById('singleView');
        const bulkView = document.getElementById('bulkView');
        const acousticsView = document.getElementById('acousticsView');
        const converterContainer = document.getElementById('converterContainer'); // Container for main converter tools

        const btnSingle = document.getElementById('btnSingle');
        const btnBulk = document.getElementById('btnBulk');
        const btnAcoustics = document.getElementById('btnAcoustics');

        const bulkGrid = document.getElementById('bulkGrid');
        const bulkRecdWarning = document.getElementById('bulkRecdWarning');

        // PTA Elements
        const ptaHlSpan = document.getElementById('ptaHl');
        const ptaSplSpan = document.getElementById('ptaSpl');
        const hfPtaHlSpan = document.getElementById('hfPtaHl');
        const hfPtaSplSpan = document.getElementById('hfPtaSpl');
        const siiValueSpan = document.getElementById('siiValue');
        const nalSiiValueSpan = document.getElementById('nalSiiValue');

        let currentView = 'single';

        function switchView(view) {
            currentView = view;

            // Reset Buttons
            [btnSingle, btnBulk, btnAcoustics].forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-gray-600', 'shadow-sm', 'text-gray-900', 'dark:text-white');
                btn.classList.add('text-gray-500', 'dark:text-gray-400');
            });

            // Activate Selected Button
            const activeBtn = view === 'single' ? btnSingle : (view === 'bulk' ? btnBulk : btnAcoustics);
            activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
            activeBtn.classList.add('bg-white', 'dark:bg-gray-600', 'shadow-sm', 'text-gray-900', 'dark:text-white');

            // Hide all Views
            singleView.classList.add('hidden');
            bulkView.classList.add('hidden');
            acousticsView.classList.add('hidden');
            converterContainer.classList.add('hidden'); // Hide shared converter controls

            if (view === 'single') {
                singleView.classList.remove('hidden');
                converterContainer.classList.remove('hidden');
                if(recdSourceSelect.value === 'CUSTOM') recdValueInput.disabled = false;
                bulkRecdWarning.classList.add('hidden');
                performConversion();
            } else if (view === 'bulk') {
                bulkView.classList.remove('hidden');
                converterContainer.classList.remove('hidden');
                recdValueInput.disabled = true;
                if(recdSourceSelect.value === 'ADULT') bulkRecdWarning.classList.remove('hidden');
                renderBulkGrid();
                updateBulkCalculations();
            } else if (view === 'acoustics') {
                acousticsView.classList.remove('hidden');
            }
        }

        // --- Logic ---

        function handleTransducerChange() {
            const type = transducerSelect.value;

            if (type === 'SF') {
                correctionSectionLabel.textContent = "Real-Ear Corrections (Real-Ear SPL Calculation)";
                recdSourceLabel.textContent = "REUG Source";
                adultRecdOption.textContent = 'Average Adult REUG (0° Azimuth)';
                recdValueLabel.textContent = "REUG Value (dB)";
            } else {
                correctionSectionLabel.textContent = "Real-Ear Corrections (REDD Calculation)";
                recdSourceLabel.textContent = "RECD Source";
                recdValueLabel.textContent = "RECD Value (dB)";
                if (type === 'TDH' || type === 'TDH39') adultRecdOption.textContent = 'Average Adult (6cc Coupler)';
                else if (type === 'ER3A') adultRecdOption.textContent = 'Average Adult (HA-1/2cc)';
                else adultRecdOption.textContent = 'Average Adult (Not Available)';
            }

            if (recdSourceSelect.value === 'ADULT') handleRECDChange();

            if (currentView === 'single') {
                filterFrequencies();
                performConversion();
            } else {
                renderBulkGrid(); // Re-render grid to show/hide extended freqs
                updateBulkCalculations();
            }
        }

        function filterFrequencies() {
            const isCAH = transducerSelect.value === 'CAH';
            const extendedFrequencies = ['9000', '10000', '11200', '12500', '14000', '16000'];
            const currentFreq = frequencySelect.value;
            let selectionChanged = false;

            Array.from(frequencySelect.options).forEach(option => {
                if (extendedFrequencies.includes(option.value)) {
                    option.style.display = isCAH ? '' : 'none';
                    if (option.value === currentFreq && !isCAH) selectionChanged = true;
                }
            });
            if (selectionChanged) frequencySelect.value = '1000';
        }

        function getCorrectionDataSet() {
            const type = transducerSelect.value;
            if (type === 'TDH' || type === 'TDH39') return CORRECTION_DATA.TDH;
            if (type === 'ER3A') return CORRECTION_DATA.INSERT;
            if (type === 'SF') return CORRECTION_DATA.SF;
            return CORRECTION_DATA.DEFAULT;
        }

        function handleRECDChange() {
            const source = recdSourceSelect.value;

            // Logic for Single View
            const freq = frequencySelect.value;
            if (source === 'NONE') {
                recdValueInput.value = '';
                recdValueInput.disabled = true;
                reddDisplay.classList.add('hidden');
                bulkRecdWarning.classList.add('hidden');
            } else if (source === 'ADULT') {
                recdValueInput.disabled = true;
                const dataset = getCorrectionDataSet();
                const avg = dataset[freq] !== undefined ? dataset[freq] : 0;
                recdValueInput.value = avg;
                reddDisplay.classList.remove('hidden');
                if(currentView === 'bulk') bulkRecdWarning.classList.remove('hidden');
            } else {
                recdValueInput.disabled = currentView === 'bulk'; // Always disable in bulk
                if (recdValueInput.value === '') recdValueInput.value = 0;
                reddDisplay.classList.remove('hidden');
                bulkRecdWarning.classList.add('hidden');
            }

            if(currentView === 'single') performConversion();
            else updateBulkCalculations();
        }

        function performConversion() {
            filterFrequencies();

            // Sync RECD value if in single mode and adult selected
            if (recdSourceSelect.value === 'ADULT') {
                const freq = frequencySelect.value;
                const dataset = getCorrectionDataSet();
                recdValueInput.value = dataset[freq] !== undefined ? dataset[freq] : 0;
            }

            const dbValue = parseFloat(dbInput.value);
            const freq = frequencySelect.value;
            const direction = document.querySelector('input[name="conversionDirection"]:checked').value;

            if (isNaN(dbValue) || dbInput.value.trim() === '') {
                displayError("Please enter a valid dB value.");
                return;
            }

            // Calculation Logic Reuse
            const resultObj = calculateSplFromHl(dbValue, freq, transducerSelect.value, recdSourceSelect.value, direction);

            if (resultObj.error) {
                displayError(resultObj.error);
                return;
            }

            outputValueElement.textContent = resultObj.result.toFixed(1);

            const textClass = document.documentElement.classList.contains('dark') ? 'text-gray-300' : 'text-gray-700';
            const context = freq === 'SPEECH' ? ' (ANSI S3.6 Speech RETSPL)' : '';

            retsplDisplay.innerHTML = `Reference Equivalent Sound Pressure Level (RETSPL) used: <span class="font-bold ${textClass}">${resultObj.retspl.toFixed(1)} dB SPL</span> (based on ${TRANSDUCER_NAMES[transducerSelect.value]} @ ${freq === 'SPEECH' ? 'Speech' : freq + ' Hz'}${context}).`;

            if (recdSourceSelect.value !== 'NONE') {
                const label = transducerSelect.value === 'SF' ? 'Total Transform' : 'REDD';
                reddDisplay.innerHTML = `Calculated ${label}: <span class="font-bold">${resultObj.totalTransform.toFixed(1)} dB</span> <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(${resultObj.retspl.toFixed(1)} + ${resultObj.correction.toFixed(1)})</span>`;
                reddDisplay.classList.remove('hidden');
            } else {
                reddDisplay.classList.add('hidden');
            }

            formulaDisplay.innerText = `Formula: ${resultObj.formula}`;
            outputUnit.textContent = resultObj.unit;

            // Note Logic
            if (direction === 'HL_to_SPL' && recdSourceSelect.value === 'NONE') {
                if (transducerSelect.value === 'CAH') {
                    outputNote.textContent = "Green values represent dB SPL in the artificial ear";
                    outputNote.classList.remove('hidden');
                } else if (transducerSelect.value !== 'SF') {
                    outputNote.textContent = "Green values represent dB SPL in the coupler";
                    outputNote.classList.remove('hidden');
                } else {
                    outputNote.classList.add('hidden');
                }
            } else {
                outputNote.classList.add('hidden');
            }


            // Reset Styles
            resultOutput.classList.remove('bg-red-100', 'border-red-500', 'dark:bg-red-900/30', 'dark:border-red-500');
            resultOutput.classList.add('bg-[#e0f2f1]', 'border-[#009688]', 'dark:bg-teal-900/30', 'dark:border-teal-500', 'border-l-4');
            outputValueElement.classList.remove('text-red-700', 'dark:text-red-400');
            outputValueElement.classList.add('text-teal-700', 'dark:text-teal-400');
        }

        // Core Calculation Helper
        function calculateSplFromHl(val, freq, transducer, recdSource, direction) {
            const retsplMap = RETSPL_REFERENCES[transducer];
            const retspl = retsplMap[freq];

            if (retspl === undefined) {
                return { error: `RETSPL N/A for ${freq} Hz` };
            }

            // Determine Correction
            let correction = 0;
            if (recdSource === 'ADULT') {
                const ds = getCorrectionDataSet(); // This relies on global state which is fine here
                correction = ds[freq] !== undefined ? ds[freq] : 0;
            } else if (recdSource === 'CUSTOM') {
                // In single mode, use the input. In bulk mode, we might need a custom strategy,
                // but for now, Bulk Custom assumes 0 or the global input if we wanted (simplification: use 0 or manual input is for single freq)
                // Let's use the input box value for single mode.
                correction = parseFloat(recdValueInput.value) || 0;
            }

            const totalTransform = retspl + correction;
            const typeLabel = transducer === 'SF' ? 'REUG' : 'RECD';

            let res, formula, unit;
            const useCorr = recdSource !== 'NONE';

            if (direction === 'HL_to_SPL') {
                if (useCorr) {
                    res = val + totalTransform;
                    formula = `Real Ear SPL = HL + RETSPL + ${typeLabel}`;
                    unit = 'dB SPL (Real Ear)';
                } else {
                    res = val + retspl;
                    formula = `Coupler SPL = HL + RETSPL`;
                    // Updated Unit logic to reflect note
                    unit = transducer === 'SF' ? 'dB SPL (Field)' : (transducer === 'CAH' ? 'dB SPL (Artificial Ear)' : 'dB SPL (Coupler)');
                }
            } else {
                if (useCorr) {
                    res = val - totalTransform;
                    formula = `HL = Real Ear SPL - (RETSPL + ${typeLabel})`;
                    unit = 'dB HL';
                } else {
                    res = val - retspl;
                    formula = `HL = Coupler SPL - RETSPL`;
                    unit = 'dB HL';
                }
            }

            return { result: res, retspl, correction, totalTransform, formula, unit };
        }

        // --- Bulk Mode Functions ---

        const STANDARD_FREQS = [125, 250, 500, 750, 1000, 1500, 2000, 3000, 4000, 6000, 8000];
        const EXTENDED_FREQS = [9000, 10000, 11200, 12500, 14000, 16000];

        function renderBulkGrid() {
            bulkGrid.innerHTML = '';
            const isCAH = transducerSelect.value === 'CAH';
            const freqsToRender = isCAH ? [...STANDARD_FREQS, ...EXTENDED_FREQS] : STANDARD_FREQS;

            const direction = document.querySelector('input[name="conversionDirection"]:checked').value;
            const inLabel = direction === 'HL_to_SPL' ? 'HL' : 'SPL';
            const outLabel = direction === 'HL_to_SPL' ? 'SPL' : 'HL';

            freqsToRender.forEach(freq => {
                const cell = document.createElement('div');
                cell.className = "bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-700";
                cell.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400">${freq} Hz</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Added text-center class to bulk inputs -->
                        <input type="number" data-freq="${freq}" oninput="updateBulkCalculations()" class="bulk-input w-16 p-1 text-sm text-center border-gray-300 rounded focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="${inLabel}">
                        <span class="text-gray-400">&rarr;</span>
                        <span id="res-${freq}" data-freq="${freq}" class="bulk-result text-sm font-bold text-teal-600 dark:text-teal-400">-</span>
                    </div>
                `;
                bulkGrid.appendChild(cell);
            });
        }

        function updateBulkCalculations() {
            const inputs = document.querySelectorAll('.bulk-input');
            const direction = document.querySelector('input[name="conversionDirection"]:checked').value;
            const recdSource = recdSourceSelect.value;
            const transducer = transducerSelect.value;

            // Arrays to store values for PTA calculations
            let ptaHlValues = [];
            let ptaSplValues = [];
            let hfPtaHlValues = [];
            let hfPtaSplValues = [];

            inputs.forEach(input => {
                const freq = parseInt(input.dataset.freq);
                const val = parseFloat(input.value);
                const outSpan = document.getElementById(`res-${freq}`);

                if (isNaN(val)) {
                    outSpan.textContent = '-';
                    outSpan.removeAttribute('data-val'); // Clear stored val
                    return;
                }

                // logic
                const retsplMap = RETSPL_REFERENCES[transducer];
                const retspl = retsplMap[freq] || 0;

                let correction = 0;
                if (recdSource === 'ADULT') {
                    const ds = getCorrectionDataSet();
                    correction = ds[freq] !== undefined ? ds[freq] : 0;
                }

                const totalTransform = retspl + correction;
                let res;
                let splVal, hlVal; // Track which is which for PTA

                if (direction === 'HL_to_SPL') {
                    // Input is HL, Output is SPL
                    res = val + (recdSource !== 'NONE' ? totalTransform : retspl);
                    hlVal = val;
                    splVal = res;
                } else {
                    // Input is SPL, Output is HL
                    res = val - (recdSource !== 'NONE' ? totalTransform : retspl);
                    splVal = val;
                    hlVal = res;
                }

                outSpan.textContent = res.toFixed(1);
                outSpan.setAttribute('data-val', res); // Store result for easier access if needed (optional)

                // Accumulate for PTA (Standard: 500, 1000, 2000)
                if ([500, 1000, 2000].includes(freq)) {
                    ptaHlValues.push(hlVal);
                    ptaSplValues.push(splVal);
                }

                // Accumulate for HF PTA (3000, 4000, 6000)
                if ([3000, 4000, 6000].includes(freq)) {
                    hfPtaHlValues.push(hlVal);
                    hfPtaSplValues.push(splVal);
                }
            });

            // Calculate Averages
            const ptaHl = calculateAverage(ptaHlValues, 3);
            const hfPtaHl = calculateAverage(hfPtaHlValues, 3);

            // Update UI for PTAs
            updateDisplay(ptaHlSpan, ptaHl);
            updateDisplay(ptaSplSpan, calculateAverage(ptaSplValues, 3));
            updateDisplay(hfPtaHlSpan, hfPtaHl);
            updateDisplay(hfPtaSplSpan, calculateAverage(hfPtaSplValues, 3));

            // Calculate SIIs
            if (ptaHl !== null && hfPtaHl !== null) {
                // Formula 1: -0.012*(Standard PTA) + -0.006*(High-Freq PTA) + 1.311
                let sii = (-0.012 * ptaHl) + (-0.006 * hfPtaHl) + 1.311;
                sii = Math.max(0, Math.min(1, sii)); // Clamp between 0 and 1
                siiValueSpan.textContent = sii.toFixed(3);

                // Formula 2 (NAL-NL2): -0.008 * (Standard PTA) + -0.005 * (High-Freq PTA) + 1.294
                let nalSii = (-0.008 * ptaHl) + (-0.005 * hfPtaHl) + 1.294;
                nalSii = Math.max(0, Math.min(1, nalSii)); // Clamp between 0 and 1
                nalSiiValueSpan.textContent = nalSii.toFixed(3);
            } else {
                siiValueSpan.textContent = '-';
                nalSiiValueSpan.textContent = '-';
            }
        }

        function calculateAverage(values, countNeeded) {
            if (values.length === countNeeded) {
                return values.reduce((a, b) => a + b, 0) / countNeeded;
            }
            return null;
        }

        function updateDisplay(element, value) {
            element.textContent = value !== null ? value.toFixed(1) : '-';
        }

        // --- Acoustics Tools Logic ---

        function toggleMath(elementId) {
            const el = document.getElementById(elementId);
            el.classList.toggle('hidden');
        }

        function togglePhaseInput() {
            const isCorrelated = document.getElementById('correlatedSources').checked;
            const container = document.getElementById('phaseInputContainer');
            if (isCorrelated) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            calculateDbSum(); // Re-calculate immediately
        }

        function togglePhaseInputSub() {
            const isCorrelated = document.getElementById('correlatedSourcesSub').checked;
            const container = document.getElementById('phaseInputContainerSub');
            if (isCorrelated) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            calculateDbSub(); // Re-calculate immediately
        }

        function calculateDbSum() {
            const v1 = parseFloat(document.getElementById('sumDb1').value);
            const v2 = parseFloat(document.getElementById('sumDb2').value);
            const isCorrelated = document.getElementById('correlatedSources').checked;
            const resSpan = document.getElementById('sumResult');

            if (!isNaN(v1) && !isNaN(v2)) {
                let sum;
                if (!isCorrelated) {
                    // Standard incoherent addition: 10 * log10( 10^(L1/10) + 10^(L2/10) )
                    sum = 10 * Math.log10(Math.pow(10, v1/10) + Math.pow(10, v2/10));
                } else {
                    // Coherent addition with phase
                    const deg = parseFloat(document.getElementById('phaseNum').value) || 0;
                    const rad = deg * (Math.PI / 180);

                    // Convert dB to pressure ratios (relative to ref)
                    // p = 10^(L/20)
                    const p1 = Math.pow(10, v1/20);
                    const p2 = Math.pow(10, v2/20);

                    // Vector addition of pressures: P_total^2 = P1^2 + P2^2 + 2*P1*P2*cos(theta)
                    // Since Intensity ~ Pressure^2, and dB = 10*log10(I/I_ref) or 20*log10(P/P_ref)
                    // The "10^(L/10)" term in standard addition effectively represents Intensity or Pressure Squared.
                    // Let's stick to Pressure summation for clarity:
                    // P_total_sq = p1*p1 + p2*p2 + 2*p1*p2*cos(rad)
                    const pSumSq = (p1 * p1) + (p2 * p2) + (2 * p1 * p2 * Math.cos(rad));

                    if (pSumSq <= 0.0000001) {
                        // Handle destructive interference (cancel out)
                        resSpan.textContent = '-∞ dB SPL';
                        return;
                    }

                    // Convert back to dB: 10 * log10(P_total^2)  (equivalent to 20 * log10(P_total))
                    sum = 10 * Math.log10(pSumSq);
                }
                resSpan.textContent = sum.toFixed(1) + ' dB SPL';
            } else {
                resSpan.textContent = '- dB SPL';
            }
        }

        function calculateDbSub() {
            const v1 = parseFloat(document.getElementById('subDb1').value);
            const v2 = parseFloat(document.getElementById('subDb2').value);
            const isCorrelated = document.getElementById('correlatedSourcesSub').checked;
            const resSpan = document.getElementById('subResult');

            if (!isNaN(v1) && !isNaN(v2)) {
                let res;
                if (!isCorrelated) {
                    // Standard incoherent subtraction: 10 * log10( 10^(L1/10) - 10^(L2/10) )
                    // Requires L1 >= L2
                    if (v2 > v1) {
                         resSpan.textContent = 'Error (L2 > L1)';
                         return;
                    }
                    const diff = Math.pow(10, v1/10) - Math.pow(10, v2/10);
                    if (diff <= 0) {
                        resSpan.textContent = '-∞ dB SPL';
                        return;
                    }
                    res = 10 * Math.log10(diff);
                } else {
                    // Coherent subtraction (Vector Difference)
                    const deg = parseFloat(document.getElementById('phaseNumSub').value) || 0;
                    const rad = deg * (Math.PI / 180);

                    const p1 = Math.pow(10, v1/20);
                    const p2 = Math.pow(10, v2/20);

                    // Vector difference magnitude squared: P_diff^2 = P1^2 + P2^2 - 2*P1*P2*cos(theta)
                    const pDiffSq = (p1 * p1) + (p2 * p2) - (2 * p1 * p2 * Math.cos(rad));

                    if (pDiffSq <= 0.0000001) {
                        resSpan.textContent = '-∞ dB SPL';
                        return;
                    }

                    res = 10 * Math.log10(pDiffSq);
                }
                resSpan.textContent = res.toFixed(1) + ' dB SPL';
            } else {
                resSpan.textContent = '- dB SPL';
            }
        }

        function calculateISL() {
            const l1 = parseFloat(document.getElementById('islLevel').value);
            const d1 = parseFloat(document.getElementById('islD1').value);
            const d2 = parseFloat(document.getElementById('islD2').value);
            const resSpan = document.getElementById('islResult');

            if (!isNaN(l1) && !isNaN(d1) && !isNaN(d2) && d1 > 0 && d2 > 0) {
                // L2 = L1 - 20 * log10(d2/d1)
                const l2 = l1 - (20 * Math.log10(d2/d1));
                resSpan.textContent = l2.toFixed(1) + ' dB SPL';
            } else {
                resSpan.textContent = '- dB SPL';
            }
        }

        function calculateExposure() {
            const level = parseFloat(document.getElementById('expLevel').value);
            const duration = parseFloat(document.getElementById('expDuration').value);

            const oshaDoseSpan = document.getElementById('oshaDose');
            const oshaTwaSpan = document.getElementById('oshaTwa');
            const nioshDoseSpan = document.getElementById('nioshDose');
            const nioshTwaSpan = document.getElementById('nioshTwa');

            if (!isNaN(level) && !isNaN(duration) && duration > 0) {
                // OSHA: Criterion 90, Exch 5, Threshold 80 (Standard Dose formula usually ignores threshold for TWA calc if we assume exposure > 80)
                // Dose % = 100 * (Duration / ReferenceDuration)
                // RefDuration = 8 / (2^((L-90)/5))
                const oshaRefTime = 8 / Math.pow(2, (level - 90)/5);
                const oshaDose = 100 * (duration / oshaRefTime);
                // TWA = 16.61 * log10(Dose/100) + 90
                const oshaTwa = 16.61 * Math.log10(oshaDose/100) + 90;

                // NIOSH: Criterion 85, Exch 3
                // RefDuration = 8 / (2^((L-85)/3))
                const nioshRefTime = 8 / Math.pow(2, (level - 85)/3);
                const nioshDose = 100 * (duration / nioshRefTime);
                // TWA = 10 * log10(Dose/100) + 85  (Since 10*log10(2) approx 3, essentially exch/log2 * log10...)
                // Actually standard formula: TWA = 10 * log10(Dose/100) + 85
                const nioshTwa = 10 * Math.log10(nioshDose/100) + 85;

                oshaDoseSpan.textContent = oshaDose.toFixed(1) + ' %';
                oshaTwaSpan.textContent = oshaTwa.toFixed(1) + ' dBA';
                nioshDoseSpan.textContent = nioshDose.toFixed(1) + ' %';
                nioshTwaSpan.textContent = nioshTwa.toFixed(1) + ' dBA';
            } else {
                oshaDoseSpan.textContent = '- %';
                oshaTwaSpan.textContent = '- dBA';
                nioshDoseSpan.textContent = '- %';
                nioshTwaSpan.textContent = '- dBA';
            }
        }

        function updateUIAndCalculate() {
            if (currentView === 'single') {
                handleTransducerChange();
                const direction = document.querySelector('input[name="conversionDirection"]:checked').value;
                const useCorrection = recdSourceSelect.value !== 'NONE';
                const type = transducerSelect.value;
                let inputUnitText = '', outputUnitText = '';
                const splLabel = useCorrection ? 'dB SPL (Real Ear)' : (type === 'SF' ? 'dB SPL (Field)' : 'dB SPL (Coupler)');

                if (direction === 'HL_to_SPL') {
                    inputUnitText = 'dB HL'; outputUnitText = splLabel;
                } else {
                    inputUnitText = splLabel; outputUnitText = 'dB HL';
                }
                inputLabel.textContent = `Input Value: ${inputUnitText}`;
                outputLabel.textContent = `Calculated ${outputUnitText}`;
                inputUnit.textContent = inputUnitText;
                performConversion();
            } else {
                // Update bulk grid placeholders/labels if direction changed
                renderBulkGrid();
                updateBulkCalculations();
            }
        }

        function displayError(message) {
            outputValueElement.textContent = 'N/A';
            retsplDisplay.innerHTML = message;
            resultOutput.classList.remove('bg-[#e0f2f1]', 'border-[#009688]', 'dark:bg-teal-900/30', 'dark:border-teal-500');
            resultOutput.classList.add('bg-red-100', 'border-red-500', 'dark:bg-red-900/30', 'dark:border-red-500', 'border-l-4');
            outputValueElement.classList.remove('text-teal-700', 'dark:text-teal-400');
            outputValueElement.classList.add('text-red-700', 'dark:text-red-400');
        }

        // --- Chart Logic --- (Chart logic remains same as previous steps, ensured UMD build above)
        let chartInstance = null;
        function toggleChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
                requestAnimationFrame(() => { requestAnimationFrame(() => { renderChart(); }); });
            }
        }
        function exportChart() {
            const canvas = document.getElementById('retsplChart');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'retspl_chart.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }
        function renderChart() {
            const ctx = document.getElementById('retsplChart').getContext('2d');
            const freqs = [125, 250, 500, 750, 1000, 1500, 2000, 3000, 4000, 6000, 8000, 9000, 10000, 11200, 12500, 14000, 16000];
            const getData = (type) => freqs.map(f => {
                const val = RETSPL_REFERENCES[type][f];
                return val !== undefined ? {x: f, y: val} : null;
            }).filter(item => item !== null);
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const customCanvasBackgroundColor = {
                id: 'customCanvasBackgroundColor',
                beforeDraw: (chart) => {
                    const ctx = chart.canvas.getContext('2d');
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff';
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                }
            };
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'TDH-49 (Supra-aural)', data: getData('TDH'), borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)', tension: 0.2, spanGaps: false },
                        { label: 'TDH-39 (Supra-aural)', data: getData('TDH39'), borderColor: 'rgb(153, 102, 255)', backgroundColor: 'rgba(153, 102, 255, 0.5)', tension: 0.2, spanGaps: false },
                        { label: 'ER-3A (Insert)', data: getData('ER3A'), borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', tension: 0.2, spanGaps: false },
                        { label: 'HDA-200 (Circumaural)', data: getData('CAH'), borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.5)', tension: 0.2, spanGaps: false },
                        { label: 'Soundfield (0°)', data: getData('SF'), borderColor: 'rgb(255, 205, 86)', backgroundColor: 'rgba(255, 205, 86, 0.5)', tension: 0.2, spanGaps: false }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'nearest', intersect: false, axis: 'x' },
                    plugins: { legend: { labels: { color: textColor } }, tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + context.parsed.y + ' dB SPL'; } } } },
                    scales: {
                        x: { type: 'logarithmic', title: { display: true, text: 'Frequency (Hz)', color: textColor }, afterBuildTicks: axis => { axis.ticks = [125, 250, 500, 750, 1000, 1500, 2000, 3000, 4000, 6000, 8000, 9000, 10000, 11200, 12500, 14000, 16000].map(v => ({ value: v })); }, ticks: { color: textColor, autoSkip: false, maxRotation: 0, minRotation: 0, callback: function(value) { const standardFreqs = [125, 250, 500, 1000, 2000, 4000, 8000, 16000]; if (standardFreqs.includes(value)) return value; return null; } }, grid: { color: gridColor }, min: 100, max: 16000 },
                        y: { title: { display: true, text: 'RETSPL (dB SPL)', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                },
                plugins: [customCanvasBackgroundColor]
            });
        }

        // SII Chart Logic
        let siiChartInstance = null;

        function toggleSiiChartModal() {
            const modal = document.getElementById('siiChartModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                if (siiChartInstance) { siiChartInstance.destroy(); siiChartInstance = null; }
                requestAnimationFrame(() => { requestAnimationFrame(() => { renderSiiChart(); }); });
            }
        }

        function renderSiiChart() {
            const ctx = document.getElementById('siiChartCanvas').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            const hfPtaValues = [0, 20, 40, 60, 80, 100];
            const ptaRange = Array.from({length: 11}, (_, i) => i * 10); // 0 to 100

            const datasets = hfPtaValues.map((hfPta, index) => {
                const colorVal = Math.floor(255 - (index * 40));
                const color = `rgb(${colorVal}, ${100 + index * 20}, 150)`;

                return {
                    label: `HFPTA = ${hfPta} dB`,
                    data: ptaRange.map(pta => {
                        let sii = (-0.012 * pta) + (-0.006 * hfPta) + 1.311;
                        return Math.max(0, Math.min(1, sii));
                    }),
                    borderColor: color,
                    backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.5)'),
                    tension: 0.1
                };
            });

            const customCanvasBackgroundColor = {
                id: 'customCanvasBackgroundColor',
                beforeDraw: (chart) => {
                    const ctx = chart.canvas.getContext('2d');
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff';
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                }
            };

            if (siiChartInstance) siiChartInstance.destroy();
            siiChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ptaRange,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'nearest', intersect: false },
                    plugins: { legend: { labels: { color: textColor } }, title: { display: true, text: 'Effect of PTAs on SII (Formula 1)', color: textColor } },
                    scales: {
                        x: { title: { display: true, text: 'Standard PTA (dB HL)', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } },
                        y: { title: { display: true, text: 'SII Score', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor }, min: 0, max: 1 }
                    }
                },
                plugins: [customCanvasBackgroundColor]
            });
        }


        // Override toggleTheme to update chart
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.theme = 'light'; sunIcon.classList.add('hidden'); moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.add('dark'); localStorage.theme = 'dark'; sunIcon.classList.remove('hidden'); moonIcon.classList.add('hidden');
            }
            if (currentView === 'single') performConversion(); // re-calc single view text

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            if (chartInstance) {
                chartInstance.options.plugins.legend.labels.color = textColor;
                chartInstance.options.scales.x.title.color = textColor;
                chartInstance.options.scales.x.ticks.color = textColor;
                chartInstance.options.scales.x.grid.color = gridColor;
                chartInstance.options.scales.y.title.color = textColor;
                chartInstance.options.scales.y.ticks.color = textColor;
                chartInstance.options.scales.y.grid.color = gridColor;
                chartInstance.update();
            }
            if (siiChartInstance) {
                siiChartInstance.options.plugins.legend.labels.color = textColor;
                siiChartInstance.options.plugins.title.color = textColor;
                siiChartInstance.options.scales.x.title.color = textColor;
                siiChartInstance.options.scales.x.ticks.color = textColor;
                siiChartInstance.options.scales.x.grid.color = gridColor;
                siiChartInstance.options.scales.y.title.color = textColor;
                siiChartInstance.options.scales.y.ticks.color = textColor;
                siiChartInstance.options.scales.y.grid.color = gridColor;
                siiChartInstance.update();
            }
        }

        document.addEventListener('DOMContentLoaded', updateUIAndCalculate);
        const observer = new MutationObserver((mutations) => { mutations.forEach((mutation) => { if (mutation.attributeName === 'class') { if(currentView === 'single') performConversion(); } }); });
        observer.observe(document.documentElement, { attributes: true });
    </script>

</body>
</html>
